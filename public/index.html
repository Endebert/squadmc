<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Squad MC">
  <link rel="apple-touch-icon" sizes="57x57" href="./favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="./favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="./favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="./favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="./favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="./favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="./favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="./favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="./favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
  <link rel="manifest" href="./favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#000000">
  <title>Robert's Mortar Calculator for Squad</title>
  <link rel="stylesheet" href="./leaflet.css"/>
  <link rel="stylesheet" href="./L.Control.MousePosition.css"/>
  <link rel="stylesheet" href="./L.easyButton.css">
  <link rel="stylesheet" href="./custom.css"/>

  <style type="text/css">
    html,
    body,
    #photo {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }
  </style>
  <script defer src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>


<body>
<div id="mapTitle" align="center">
  <div id="mapName">Al Basrah</div>
  <table>
    <tr>
      <td><img class="inline" src="mortar.png" width="16px" height="16px"/>
        <div class="inline keypad" id="mortarPos">&nbsp;&nbsp;-&nbsp;-&nbsp;</div>
      </td>
      <td><img class="inline" src="target.png" width="16px" height="16px"/>
        <div class="inline keypad" id="targetPos">&nbsp;&nbsp;-&nbsp;-&nbsp;</div>
      </td>
    </tr>
  </table>
  <div class="keypad" id="mapAngle">&nbsp;&nbsp;&nbsp;Â°</div>&nbsp;<div class="keypad" id="mapBearing">&nbsp;&nbsp;&nbsp;&nbsp;</div>
</div>

<div id="mousecoord" class="leaflet-control-mouseposition-target">THIS IS A TEST</div>
<div id="photo"></div>
<script src="./leaflet-src.js"></script>
<script src="./squadcalc.js"></script>
<script src="./utils.js"></script>
<script type="text/javascript" src="./L.CRS.SimpleTopLeft.js"></script>
<script type="text/javascript" src="./L.Calculator.js"></script>
<script type="text/javascript" src="./L.SquadGrid.js"></script>
<script type="text/javascript" src="./L.Control.MousePosition.js"></script>
<script src="./L.easyButton.js"></script>
<script type="text/javascript">

  const DEBUG = false;

  const iSize = 48; // icon size

  const mortarIcon = L.icon({
    iconUrl: 'mortar.png',

    iconSize: [iSize, iSize], // size of the icon
    iconAnchor: [iSize / 2, iSize / 2], // point of the icon which will correspond to marker's location
    popupAnchor: [0, -iSize / 2], // point from which the popup should open relative to the iconAnchor
  });

  const targetIcon = L.icon({
    iconUrl: 'target.png',

    iconSize: [iSize, iSize], // size of the icon
    iconAnchor: [iSize / 2, iSize / 2], // point of the icon which will correspond to marker's location
    popupAnchor: [0, -iSize / 2], // point from which the popup should open relative to the iconAnchor
  });

  const albasrah = L.imageOverlay('./maps/albasrah.jpg', [[0, 0], [3200, 3200]]);
  const chora = L.imageOverlay('./maps/chora.jpg', [[0, 0], [4073, 4073]]);
  const foolsroad = L.imageOverlay('./maps/foolsroad.jpg', [[0, 0], [1775, 1739]]);
  const forest = L.imageOverlay('./maps/forest.jpg', [[0, 0], [1200, 1200]]);
  const gorodok = L.imageOverlay('./maps/gorodok.jpg', [[0, 0], [4347, 4347]]);
  const jensens = L.imageOverlay('./maps/jensens.jpg', [[0, 0], [1513, 1513]]);
  const kohat = L.imageOverlay('./maps/kohat.jpg', [[0, 0], [4026, 4026]]);
  const kokan = L.imageOverlay('./maps/kokan.jpg', [[0, 0], [2500, 2500]]);
  const logarvalley = L.imageOverlay('./maps/logarvalley.jpg', [[0, 0], [1765, 1765]]);
  const mestia = L.imageOverlay('./maps/mestia.jpg', [[0, 0], [2403, 2403]]);
  const narva = L.imageOverlay('./maps/narva.jpg', [[0, 0], [2205, 2205]]);
  const sumari = L.imageOverlay('./maps/sumari.jpg', [[0, 0], [1303, 1303]]);
  const yehorivka = L.imageOverlay('./maps/yehorivka.jpg', [[0, 0], [4041, 4041]]);

  // debug maps
  const albasrah_l = L.imageOverlay('./maps/albasrah_l.jpg', [[0, 0], [3200, 3200]]);
  const chora_l = L.imageOverlay('./maps/chora_l.jpg', [[0, 0], [4073, 4073]]);
  const foolsroad_l = L.imageOverlay('./maps/foolsroad_l.jpg', [[0, 0], [1775, 1739]]);
  const forest_l = L.imageOverlay('./maps/forest_l.jpg', [[0, 0], [1200, 1200]]);
  const gorodok_l = L.imageOverlay('./maps/gorodok_l.jpg', [[0, 0], [4347, 4347]]);
  const jensens_l = L.imageOverlay('./maps/jensens_l.jpg', [[0, 0], [1513, 1513]]);
  const kohat_l = L.imageOverlay('./maps/kohat_l.jpg', [[0, 0], [4026, 4026]]);
  const kokan_l = L.imageOverlay('./maps/kokan_l.jpg', [[0, 0], [2500, 2500]]);
  const logarvalley_l = L.imageOverlay('./maps/logarvalley_l.jpg', [[0, 0], [1765, 1765]]);
  const mestia_l = L.imageOverlay('./maps/mestia_l.jpg', [[0, 0], [2403, 2403]]);
  const narva_l = L.imageOverlay('./maps/narva_l.jpg', [[0, 0], [2205, 2205]]);
  const sumari_l = L.imageOverlay('./maps/sumari_l.jpg', [[0, 0], [1303, 1303]]);
  const yehorivka_l = L.imageOverlay('./maps/yehorivka_l.jpg', [[0, 0], [4041, 4041]]);

  const baseMaps = {
    'Al Basrah': albasrah,
    'Chora Valley': chora,
    "Fool's Road": foolsroad,
    'Operation First Light': forest,
    Gorodok: gorodok,
    "Jensen's Range": jensens,
    'Kohat Toi River Valley': kohat,
    Kokan: kokan,
    'Logar Valley': logarvalley,
    Mestia: mestia,
    Narva: narva,
    'Sumari Bala': sumari,
    Yehorivka: yehorivka,

    'DEBUG: Al Basrah': albasrah_l,
    'DEBUG: Chora Valley': chora_l,
    "DEBUG: Fool's Road": foolsroad_l,
    'DEBUG: Operation First Light': forest_l,
    'DEBUG: Gorodok': gorodok_l,
    "DEBUG: Jensen's Range": jensens_l,
    'DEBUG: Kohat Toi River Valley': kohat_l,
    'DEBUG: Kokan': kokan_l,
    'DEBUG: Logar Valley': logarvalley_l,
    'DEBUG: Mestia': mestia_l,
    'DEBUG: Narva': narva_l,
    'DEBUG: Sumari Bala': sumari_l,
    'DEBUG: Yehorivka': yehorivka_l,
  };

  let mo = {}; // map objects
  const fo = {}; // flag objects

  fo['Al Basrah'] = [
    createLocation('Village', [2000, 760]),
    createLocation('US Airfield', [770, 1070]),
    createLocation('US Checkpoint', [1550, 1530]),
    createLocation('Outskirts', [2050, 1600]),
    createLocation('Refinery', [1939, 2070]),
    createLocation('Mosque', [2107, 1882]),
    createLocation('Oasis', [2448, 1575]),
    createLocation('Suburbs', [2307, 1941]),
    createLocation('Alleys', [2238, 2243]),
    createLocation('Fringe', [2713, 1541]),
    createLocation('Estates', [2705, 2087]),
  ];

  fo['Chora Valley'] = [
    createLocation('Russia Main', [2730, 600]),
    createLocation('Monolith', [2345, 850]),
    createLocation('SW Nursery', [2529, 1213]),
    createLocation('Orchard', [1835, 1428]),
    createLocation('Radio Station', [2224, 1898]),
    createLocation('Hemp Farm', [1755, 2148]),
    createLocation('Gas Station', [1817, 2511]),
    createLocation('US Main', [1795, 2905]),
  ];

  const grid = L.squadGrid({
    redraw: 'moveend',
  });

  const map = L.map('photo', {
    crs: L.CRS.Simple,
    minZoom: -3,
    maxZoom: 2,
    attributionControl: true,
    layers: [grid],
    zoomSnap: 0,
  });

  // noinspection JSNonASCIINames
  const overlayMaps = {
    'Keypad grid': grid,
  };
  const layerControl = L.control.layers(baseMaps, overlayMaps);
  layerControl.addTo(map);

  const scaleControl = L.control.scale({
    maxWidth: 300, metric: true, imperial: false, position: 'bottomright',
  });
  scaleControl.addTo(map);

  const mouseControl = L.control.mousePosition();
  mouseControl.addTo(map);

  const calcLayer = L.calculator();
  calcLayer.addTo(map);

  // L.easyButton('fas fa-binoculars', function (btn, map) {
  //     DEBUG = !DEBUG;
  // }).addTo(map);
  const flagMarkerGroup = L.layerGroup();
  map.addLayer(flagMarkerGroup);

  function onBaseLayerChange(e) {
    layerControl.collapse();
    console.log('layer changed:', e.name);
    document.getElementById('mapName').innerText = e.name;
    console.log('layer:', e.layer);
    reInit(e.layer.getBounds(), e.name);
    localStorage.setItem('lastLayer', e.name);
  }

  map.on('baselayerchange', onBaseLayerChange);
  function reInit(bounds, layerName) {
    try {
      flagMarkerGroup.eachLayer((layer) => {
        flagMarkerGroup.removeLayer(layer);
      });
      const m = layerName;
      for (const f in fo[m]) {
        console.log('f:', fo[m][f]);
        fo[m][f].addTo(flagMarkerGroup);
      }
    } catch (e) {
      console.log('reIniting flagMarkers failed:', e);
    }
    try {
      markerGroup.eachLayer((layer) => {
        markerGroup.removeLayer(layer);
      });
      mo = {};
    } catch (e) {
      // do nothing
    }

    console.log('reInit with bounds:', bounds);
    map.setMaxBounds(bounds);
    map.fitBounds(bounds);
  }

  let m = localStorage.getItem('lastLayer');

  if (!m) {
    for (m in baseMaps) break;
  } // get first object and stop loop
  map.setView(baseMaps[m].getBounds().getCenter(), -5);
  map.addLayer(baseMaps[m]);
</script>
</body>

</html>
